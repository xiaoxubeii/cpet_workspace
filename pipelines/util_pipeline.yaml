metadata:
  name: "cpet_util_pipeline"
  vars:
    RUNS_DIR: "{EXPERIMENT_HOME}/sota"
    RUN_DIR: "{RUNS_DIR}/{RUN_TS}"
    model_list: "{model_list}"
    data_file: "/home/cheng/workspace/cpetx_workspace/generate_dataset/artifacts/cpet_dataset.h5"
    subset_data_file: "/home/cheng/workspace/cpetx_workspace/generate_dataset/artifacts/cpet_dataset_medium.h5"
  envs:
    PYTHONUNBUFFERED: "1"
    PYTHONPATH: "{EXPERIMENT_HOME}/src"
    CPETX_PROJECT_ROOT: "{EXPERIMENT_HOME}"
    CONFIGS_DIR: "{EXPERIMENT_HOME}/configs"

steps:
  - id: eval-models
    type: shell
    description: "Evaluate models"
    vars:
      RUN_DIR: "{RUNS_DIR}/{RUN_TS}/{TASK_ID}"
      checkpoints_path: "{checkpoints_path}"
    command: |
      set -e
      for ARCH in {model_list}; do
        set -e
        EVAL_SUB="{RUN_DIR}/${{ARCH}}"
        mkdir -p "${{EVAL_SUB}}/logs" "${{EVAL_SUB}}/results"
        PYTHONPATH={EXPERIMENT_HOME}/src python {EXPERIMENT_HOME}/src/vox_cpet/cmd/cpetx-model eval \
          --task-id "{TASK_ID}_${{ARCH}}" \
          --conf {CONFIGS_DIR}/eval \
          --data-file {data_file} \
          --filter "^${{ARCH}}$" \
          --run-dir "${{EVAL_SUB}}" \
          --save-dir "${{EVAL_SUB}}/results" \
          --log-dir "${{EVAL_SUB}}/logs" \
          --checkpoints-path "{checkpoints_path}"
      done